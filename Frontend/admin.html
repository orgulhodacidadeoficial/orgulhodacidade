<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Inscri√ß√µes</title>
  <style>
    body{font-family:Inter,Arial,sans-serif;margin:0;background:#f5f7fa;color:#111;-webkit-text-size-adjust:100%;overflow-x:hidden}
    header{background:linear-gradient(135deg, #0b3a91 0%, #0052cc 100%);color:#fff;padding:1rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.75rem;box-shadow:0 2px 10px rgba(11,58,145,0.15)}
    header h1{font-size:1.1rem;margin:0}
    .wrap{max-width:1200px;margin:0.5rem auto;padding:0.75rem}
    .row{display:flex;gap:1rem;flex-wrap:wrap}
    .compact-list{display:flex;flex-direction:column;gap:1rem}
    .inscricao-compact{background:#fff;border-radius:8px;padding:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
    .compact-row{margin-bottom:0.5rem}
    .compact-datetime{color:#666;font-size:0.85rem;margin-bottom:0.25rem}
    .compact-name{font-weight:600;font-size:1.1rem;margin-bottom:0.25rem}
    .compact-part{color:#0b5cff;font-weight:500;text-transform:capitalize}
    .detail-row{display:grid;grid-template-columns:140px 1fr;gap:0.5rem;padding:0.5rem 0;border-bottom:1px solid #eee}
    .detail-row:last-child{border:none}
    .detail-row strong{color:#555;font-size:0.9rem}
    
    /* Search and filter styles */
    .section-header{display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap}
    .section-title{margin:0;color:#0b3a91;font-size:1.5rem}
    .section-stats{color:#666;font-size:0.95rem;font-weight:500}
    .search-filter{display:flex;gap:0.75rem;flex:1;min-width:300px;flex-wrap:wrap}
    .search-input{padding:0.6rem 1rem;border:1px solid #ddd;border-radius:6px;font-size:0.95rem;flex:1;min-width:200px}
    .search-input:focus{outline:none;border-color:#0b5cff;box-shadow:0 0 0 3px rgba(11,92,255,0.1)}
    
    /* Cards Grid */
    .cards-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));gap:1.25rem;margin-top:1rem}
    .data-card{background:#fff;border-radius:10px;padding:1.25rem;box-shadow:0 2px 8px rgba(0,0,0,0.05);border-left:4px solid #0b5cff;transition:all 0.2s ease}
    .data-card:hover{box-shadow:0 4px 16px rgba(0,0,0,0.1);transform:translateY(-2px)}
    .data-card.contact{border-left-color:#00b37a}
    .data-card.contractor{border-left-color:#ff7a00}
    .card-field{margin-bottom:0.75rem;display:flex;flex-direction:column}
    .card-field-label{font-size:0.85rem;color:#999;text-transform:uppercase;font-weight:600;letter-spacing:0.5px;margin-bottom:0.25rem}
    .card-field-value{font-size:0.95rem;color:#333;font-weight:500;word-break:break-word}
    .card-actions{display:flex;gap:0.5rem;margin-top:1rem;padding-top:1rem;border-top:1px solid #eee}
    
    @media (max-width: 768px) {
      header{padding:0.5rem;gap:0.5rem}
      header h1{width:100%;margin-bottom:0.5rem;font-size:1rem}
      .controls{width:100%;overflow-x:auto;padding-bottom:0.25rem}
      .controls::-webkit-scrollbar{height:3px}
      .controls::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2)}
      .wrap{padding:0.5rem;margin:0}
      .cards-grid{grid-template-columns:1fr}
      .section-header{flex-direction:column;align-items:flex-start}
      .search-filter{min-width:100%}
    }
    /* Modal styles */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000;padding:0.5rem}
    .modal-content{background:#fff;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.15);width:92%;max-width:800px;max-height:90vh;overflow-y:auto;position:relative}
    .modal-header{padding:1rem;border-bottom:1px solid #eee;position:sticky;top:0;background:#fff;display:flex;justify-content:space-between;align-items:center;z-index:1}
    .modal-body{padding:1.5rem}
    .modal-actions{padding:1rem;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:0.75rem}
    .btn-close{position:absolute;right:0.75rem;top:0.75rem;background:none;border:none;font-size:1.5rem;cursor:pointer;padding:0.25rem;line-height:1}
    .preview-table{width:100%;border-collapse:collapse;margin:0.5rem 0}
    .preview-table th{text-align:left;background:#f5f5f5;font-weight:600;width:180px}
    .preview-table th,.preview-table td{padding:0.6rem;border:1px solid #ddd;vertical-align:top}
    .btn-download{background:#0b5cff;color:#fff;border:none;padding:0.6rem 1rem;border-radius:6px;cursor:pointer;font-size:0.95rem}
    .btn-cancel{background:#f3f3f3;color:#666;border:1px solid #ddd}
    @media (max-width: 768px) {
      .modal-overlay{padding:0}
      .modal-content{width:100%;height:100%;max-height:100vh;border-radius:0}
      .modal-header{padding:0.75rem}
      .modal-body{padding:0.75rem}
      .modal-actions{padding:0.75rem;gap:0.5rem;flex-wrap:wrap}
      .preview-table{font-size:0.9rem}
      .preview-table th{width:110px;white-space:nowrap}
      .preview-table th,.preview-table td{padding:0.5rem;font-size:0.9rem}
      .btn-download,.btn-cancel{width:100%;padding:0.75rem;font-size:0.95rem;text-align:center}
    }
    .card{background:#fff;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.06);padding:1.25rem;flex:1;min-width:300px;margin-top:1rem}
    table{width:100%;border-collapse:collapse;font-size:0.95rem}
    th{padding:0.75rem;border-bottom:2px solid #ddd;text-align:left;font-weight:600;color:#444}
    td{padding:0.75rem;border-bottom:1px solid #eee;text-align:left}
    td pre{margin:0;font-family:inherit;font-size:inherit}
    tr:hover{background:#f8f9ff}
    .controls{display:flex;gap:0.5rem}
    button{background:#0046ad;color:#fff;border:none;padding:0.45rem 0.6rem;border-radius:6px;cursor:pointer;white-space:nowrap;font-size:0.9rem;transition:all 0.2s ease}
    button:hover{opacity:0.9;transform:translateY(-1px)}
    .logout{background:#dc2626}
    .btn-delete{background:#dc2626}
    .btn-delete:hover{background:#b91c1c}
    pre{white-space:pre-wrap;word-break:break-word}
    @media (max-width: 768px) {
      .card{padding:0.75rem;border-radius:6px;margin-top:0.75rem}
      table{font-size:0.85rem}
      th,td{padding:0.4rem}
      button{padding:0.4rem 0.5rem;font-size:0.85rem}
      #btnRelatorio{font-size:0.85rem}
    }
  </style>
  <!-- √çcones do site (favicon) -->
  <link rel="icon" type="image/png" sizes="32x32" href="logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="logo.png">
  <link rel="shortcut icon" href="logo.png" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="180x180" href="logo.png">
  <meta name="theme-color" content="#ff8a00">
</head>
<body>
  <header>
    <h1>Painel Administrativo</h1>
    <div class="controls">
      <button id="btnHome" onclick="window.location.href='index.html'" style="background:#e00606;">Ir para o Site</button>
      <button id="btnIns">Carregar Inscri√ß√µes</button>
      <button id="btnCont">Carregar Contatos</button>
      <button id="btnConr">Carregar Contrata√ß√µes</button>
      
      <button id="btnLogout" class="logout">Sair</button>
    </div>
  </header>

   
  <div class="wrap">
    <div id="content"></div>
  </div>

  <script>
    const contentEl = document.getElementById('content');
    async function fetchJson(url){
      const r = await fetch(url, { credentials: 'include' });
      if (!r.ok) throw new Error('Falha ao carregar');
      return r.json();
    }

  // render inscri√ß√µes with a chart by tipo_participacao
  // On mobile/tablet we show a compact list (date/time, name, participation)
  // with a per-person expandable details panel to keep the admin list readable.
  function renderInscricoes(arr){
        if (!Array.isArray(arr) || arr.length === 0) {
          contentEl.innerHTML = `<div class="card"><h3>Inscri√ß√µes</h3><p>Nenhum registro encontrado.</p></div>`;
          return;
        }

        // preserve original indices so deletes map to file order
        const withIndex = arr.map((v, i) => Object.assign({}, v, { _origIndex: i }));

        // sort by receivedAt (timestamp) desc
        const sorted = withIndex.slice().sort((a, b) => (b.receivedAt || 0) - (a.receivedAt || 0));

        // count types for chart
        const counts = {};
        sorted.forEach(item => {
          const t = (item.tipo_participacao || 'Outros').toString().trim().toLowerCase();
          counts[t] = (counts[t] || 0) + 1;
        });
        console.log('Contagem de tipos:', counts);

        // build html with canvas for chart and either a table (desktop)
        // ou cards (mobile/tablet). Detecta viewport width
        const isCompact = true; // Sempre usar cards

        let html = `<div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem">
            <h3 style="margin:0">Inscri√ß√µes por Tipo</h3>
            <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
              <button id="btnRelatorio" style="background:#0046ad">üìã Gerar Relat√≥rio</button>
              <button id="clearInsBtn" class="btn-delete" style="padding:0.45rem 0.6rem">üóëÔ∏è Limpar todos</button>
            </div>
          </div>
          <div style="height:300px;margin-bottom:1.5rem"><canvas id="insChart"></canvas></div>`;

        // Build either a full table (desktop) or a compact list (mobile/tablet)
        if (!isCompact) {
          // Desktop: show full table + chart
          const keys = new Set();
          withIndex.forEach(v => Object.keys(v).forEach(k => keys.add(k)));
          // Remove specific fields from desktop view
          keys.delete('receivedAt');
          keys.delete('_origIndex');
          keys.delete('ip');
          keys.delete('email');
          const otherKeys = Array.from(keys);

          html += `<div class="table-responsive"><table><thead><tr><th>Recebido</th>`;
          otherKeys.forEach(h=> html += `<th>${h}</th>`);
          html += `<th>A√ß√µes</th></tr></thead><tbody>`;

          sorted.forEach(item => {
            html += '<tr>';
            const ts = item.receivedAt ? new Date(Number(item.receivedAt)).toLocaleString('pt-BR', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            }) : '';
            html += `<td><pre>${ts}</pre></td>`;
            otherKeys.forEach(h=>{
              let v = item[h];
              if (v === undefined) v = '';
              if (typeof v === 'object') v = JSON.stringify(v);
              if (h === 'nome') {
                v = String(v).toUpperCase();
              } else if (h === 'bairro') {
                v = String(v).toUpperCase();
              } else if (h === 'tipo_participacao') {
                v = String(v).toLowerCase();
                v = v.charAt(0).toUpperCase() + v.slice(1);
              }
              if (h === 'telefone') {
                v = `üì± ${v}`;
              }
              html += `<td><pre>${String(v)}</pre></td>`;
            });
            // actions: View (Word) + Delete
            html += `<td style="white-space:nowrap">`;
            html += `<button data-idx="${item._origIndex}" class="verIns" style="background:#0b5cff;margin-right:6px">ÔøΩ Ver</button>`;
            html += `<button data-idx="${item._origIndex}" class="delIns" style="background:#dc2626">üóëÔ∏è</button>`;
            html += `</td>`;
            html += '</tr>';
          });
          html += `</tbody></table></div></div>`;
        } else {
          // Mobile/tablet: show as cards (same format as contatos and contrata√ß√µes)
          
          html += `
          <div class="search-filter">
            <input type="text" id="searchInscricoes" class="search-input" placeholder="üîç Buscar inscri√ß√µes por nome ou participa√ß√£o...">
          </div>
          
          <div class="cards-grid" id="inscricoesGrid"></div>
          </div>`;
          
          contentEl.innerHTML = html;
          const grid = document.getElementById('inscricoesGrid');
          const searchInput = document.getElementById('searchInscricoes');
          
          function renderCards(items) {
            if (items.length === 0) {
              grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:#999">Nenhum resultado encontrado</div>';
              return;
            }
            
            grid.innerHTML = items.map((item) => {
              const originalIdx = item._origIndex;
              const nome = item.nome || 'Sem nome';
              const tipo = item.tipo_participacao || '-';
              const telefone = item.telefone || item.phone || '-';
              const bairro = item.bairro || '-';
              const idade = item.idade || item.age || '-';
              
              return `
                <div class="data-card" style="border-left-color:#0b5cff">
                  <div class="card-field">
                    <div class="card-field-label">üë§ Nome</div>
                    <div class="card-field-value">${nome}</div>
                  </div>
                  <div class="card-field">
                    <div class="card-field-label">üé≠ Tipo de Participa√ß√£o</div>
                    <div class="card-field-value">${tipo}</div>
                  </div>
                  <div class="card-field">
                    <div class="card-field-label">üì± Telefone</div>
                    <div class="card-field-value"><a href="tel:${telefone}" style="color:#0b5cff;text-decoration:none">${telefone}</a></div>
                  </div>
                  <div class="card-field">
                    <div class="card-field-label">üè† Bairro</div>
                    <div class="card-field-value">${bairro}</div>
                  </div>
                  ${idade !== '-' ? `<div class="card-field">
                    <div class="card-field-label">üéÇ Idade</div>
                    <div class="card-field-value">${idade}</div>
                  </div>` : ''}
                  ${item.receivedAt ? `<div class="card-field">
                    <div class="card-field-label">üìÖ Data da Inscri√ß√£o</div>
                    <div class="card-field-value">${new Date(Number(item.receivedAt)).toLocaleDateString('pt-BR')} √†s ${new Date(Number(item.receivedAt)).toLocaleTimeString('pt-BR')}</div>
                  </div>` : ''}
                  <div class="card-actions">
                    <button data-idx="${originalIdx}" class="verIns" style="flex:1;background:#0b5cff">Ver Detalhes</button>
                    <button data-idx="${originalIdx}" class="delIns" style="flex:1;background:#dc2626">üóëÔ∏è Excluir</button>
                  </div>
                </div>
              `;
            }).join('');
            
            // Reattach event handlers
            document.querySelectorAll('.verIns').forEach(btn => btn.addEventListener('click', viewInscricao));
            document.querySelectorAll('.delIns').forEach(btn => btn.addEventListener('click', deleteInscricao));
          }
          
          function viewInscricao(e) {
            const idx = Number(e.currentTarget.getAttribute('data-idx'));
            const item = arr[idx];
            if (!item) return alert('Inscri√ß√£o n√£o encontrada');
            showInscricaoPreview(item);
          }
          
          function deleteInscricao(e) {
            const idx = Number(e.currentTarget.getAttribute('data-idx'));
            const nome = arr[idx].nome || 'Inscri√ß√£o';
            
            if (!confirm(`‚ö†Ô∏è Deseja excluir a inscri√ß√£o de ${nome}?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
              return;
            }
            
            const confirmText = prompt('‚ö†Ô∏è √öltima chance!\n\nPara confirmar a exclus√£o, digite CONFIRMAR (mai√∫sculas):');
            const userInput = (confirmText || '').trim().toUpperCase();
            if (userInput !== 'CONFIRMAR') {
              alert('‚ùå Opera√ß√£o cancelada! Texto n√£o corresponde a "CONFIRMAR".');
              return;
            }
            
            (async () => {
              try {
                const r = await fetch('/api/admin/inscricoes/delete', {
                  method: 'POST',
                  credentials: 'include',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ index: idx })
                });
                if (!r.ok) {
                  const errData = await r.json().catch(() => ({ error: 'Erro ao deletar' }));
                  throw new Error(errData.error || `Erro ${r.status}`);
                }
                alert('‚úÖ Inscri√ß√£o exclu√≠da com sucesso');
                document.getElementById('btnIns').click();
              } catch (err) {
                console.error('Erro ao deletar inscri√ß√£o:', err);
                alert('‚ùå Erro: ' + err.message);
              }
            })();
          }
          
          renderCards(sorted);
          
          // Renderizar gr√°fico DEPOIS que o DOM estiver pronto
          setTimeout(() => {
            const labels = Object.keys(counts).map(l => l.charAt(0).toUpperCase() + l.slice(1));
            const data = Object.keys(counts).map(l => counts[l]);
            console.log('Labels:', labels);
            console.log('Data:', data);
            console.log('Counts:', counts);
            
            function onceLoaded(){
              try{
                const ctx = document.getElementById('insChart');
                if (!ctx) {
                  console.error('Canvas insChart n√£o encontrado');
                  return;
                }
                const canvasCtx = ctx.getContext('2d');
                // eslint-disable-next-line no-undef
                new Chart(canvasCtx, {
                  type: 'bar',
                  data: {
                    labels,
                    datasets: [{
                      label: 'Quantidade',
                      data,
                      backgroundColor: ['#0b5cff','#ff7a00','#00b37a','#7a3cff']
                    }]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      title: { display: false },
                      legend: { display: false },
                      tooltip: { enabled: true }
                    },
                    scales: {
                      y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                      }
                    }
                  }
                });
              }catch(e){ console.error('Erro ao renderizar gr√°fico', e); }
            }
            if (window.Chart) return onceLoaded();
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
            s.onload = onceLoaded; s.onerror = ()=>console.warn('N√£o foi poss√≠vel carregar Chart.js');
            document.head.appendChild(s);
          }, 100);
          
          searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = sorted.filter(item => {
              const nome = (item.nome || '').toLowerCase();
              const tipo = (item.tipo_participacao || '').toLowerCase();
              return nome.includes(term) || tipo.includes(term);
            });
            renderCards(filtered);
          });
          
          // Bot√£o de limpar todas as inscri√ß√µes (mobile/cards)
          const clearBtn = document.getElementById('clearInsBtn');
          console.log('[INSCRI√á√ïES CARDS] clearBtn:', clearBtn);
          if (clearBtn) {
            clearBtn.addEventListener('click', async ()=>{
              const total = arr.length;
              if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ est√° prestes a APAGAR TODAS AS ${total} ${total === 1 ? 'INSCRI√á√ÉO' : 'INSCRI√á√ïES'}!\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
                return;
              }
              
              const confirmText = prompt('Para confirmar, digite CONFIRMAR em mai√∫sculas:');
              if (confirmText !== 'CONFIRMAR') {
                alert('‚ùå Opera√ß√£o cancelada!');
                return;
              }
              
              try{
                const r = await fetch('/api/admin/inscricoes/clear', { method: 'POST', credentials: 'include' });
                if (!r.ok) throw new Error('Falha ao limpar as inscri√ß√µes');
                alert(`‚úÖ ${total} ${total === 1 ? 'inscri√ß√£o foi' : 'inscri√ß√µes foram'} removida(s) com sucesso`);
                document.getElementById('btnIns').click();
              }catch(e){ 
                alert('‚ùå Erro: ' + e.message); 
              }
            });
          }
          
          return;
        }
        
        html += `</div>`;
        contentEl.innerHTML = html;
        contentEl.innerHTML = html;

        // attach toggle handlers for compact details
        document.querySelectorAll('.btn-toggle-details').forEach(btn=> btn.addEventListener('click', function(){
          const idx = this.getAttribute('data-idx');
          const el = document.querySelector('.inscricao-compact[data-idx="'+idx+'"] .inscricao-details');
          if (!el) return; el.style.display = (el.style.display === 'none') ? 'block' : 'none';
        }));

        // attach Ver (download Word) handlers
        attachVerHandlers(withIndex);

        

        // attach delete handlers for each inscription
        // Bot√£o de relat√≥rio
        document.getElementById('btnRelatorio').addEventListener('click', () => {
          window.open('/relatorio-inscricoes.html', '_blank');
        });

        // Bot√£o de limpar todas as inscri√ß√µes
        setTimeout(() => {
          const clearBtn = document.getElementById('clearInsBtn');
          console.log('[INSCRI√á√ïES] clearBtn:', clearBtn);
          if (clearBtn) {
            clearBtn.addEventListener('click', async ()=>{
              const total = arr.length;
              if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ est√° prestes a APAGAR TODAS AS ${total} ${total === 1 ? 'INSCRI√á√ÉO' : 'INSCRI√á√ïES'}!\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
                return;
              }
              
              const confirmText = prompt('Para confirmar, digite CONFIRMAR em mai√∫sculas:');
              if (confirmText !== 'CONFIRMAR') {
                alert('‚ùå Opera√ß√£o cancelada!');
                return;
              }
              
              try{
                const r = await fetch('/api/admin/inscricoes/clear', { method: 'POST', credentials: 'include' });
                if (!r.ok) throw new Error('Falha ao limpar as inscri√ß√µes');
                alert(`‚úÖ ${total} ${total === 1 ? 'inscri√ß√£o foi' : 'inscri√ß√µes foram'} removida(s) com sucesso`);
                document.getElementById('btnIns').click();
              }catch(e){ 
                alert('‚ùå Erro: ' + e.message); 
              }
            });
          }
        }, 100);

        // Bot√µes de excluir (apenas para desktop - mobile usa eventos em renderCards)
        setTimeout(() => {
          document.querySelectorAll('.delIns').forEach(btn => {
            // Verifica se √© em uma tabela (desktop) ou em cards (mobile)
            const isInTable = btn.closest('table') !== null;
            if (!isInTable) return; // Pula se estiver em cards mobile
            
            btn.addEventListener('click', async (e) => {
              const idx = Number(e.currentTarget.getAttribute('data-idx'));
              const row = e.currentTarget.closest('tr');
              let nome = '';
              if (row) {
                nome = row.querySelector('td:nth-child(2) pre') ? row.querySelector('td:nth-child(2) pre').textContent : '';
              }

              if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ est√° prestes a EXCLUIR esta inscri√ß√£o:\n${nome}\n\nEsta a√ß√£o n√£o pode ser desfeita. Deseja continuar?`)) {
                alert('‚ùå Opera√ß√£o cancelada!');
                return;
              }

              const confirmText = prompt('‚ö†Ô∏è √öltima chance!\n\nPara confirmar a exclus√£o, digite CONFIRMAR (mai√∫sculas):');
              const userInput = (confirmText || '').trim().toUpperCase();
              if (userInput !== 'CONFIRMAR') {
                alert('‚ùå Opera√ß√£o cancelada! Texto n√£o corresponde a "CONFIRMAR".');
                return;
              }

              try {
                const r = await fetch('/api/admin/inscricoes/delete', {
                  method: 'POST',
                  credentials: 'include',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ index: idx })
                });
                if (!r.ok) {
                  let details = '';
                  try { const data = await r.json(); details = data && (data.error || JSON.stringify(data)); } catch(e) { try { details = await r.text(); } catch(_) { details = ''; } }
                  console.error('Erro ao excluir inscri√ß√£o', r.status, details);
                  if (r.status === 401) throw new Error('N√£o autorizado. Fa√ßa login novamente.');
                  throw new Error((details && details.toString()) || ('Status ' + r.status));
                }
                alert('‚úÖ Inscri√ß√£o exclu√≠da com sucesso');
                document.getElementById('btnIns').click();
              } catch (err) {
                console.error(err);
                alert('‚ùå Erro ao excluir inscri√ß√£o!\n\n' + err.message + '\n\nVerifique o console do servidor para mais detalhes.');
              }
            });
          });
        }, 100);

        // Preview inscription data in a modal and offer download
        function showInscricaoPreview(obj) {
          // Create and show modal with preview
          const modal = document.createElement('div');
          modal.className = 'modal-overlay';
          
          const title = (obj.nome || 'Inscri√ß√£o').toString();
          let html = `
            <div class="modal-content">
              <div class="modal-header">
                <h2 style="margin:0;font-size:1.2rem">INSCRI√á√ÉO - ${title.toUpperCase()}</h2>
                <button class="btn-close">&times;</button>
              </div>
              <div class="modal-body">
                <table class="preview-table">`;

          Object.keys(obj).forEach(k => {
            // Skip internal fields and IP
            if (k === '_origIndex' || k === 'ip') return;
            let v = obj[k];
            if (typeof v === 'object') v = JSON.stringify(v, null, 2);
            if (k === 'receivedAt') {
              v = new Date(Number(v)).toLocaleString().toUpperCase();
              k = 'DATA/HORA';
            } else {
              k = k.toUpperCase(); // Converte chave para mai√∫sculas
              if (typeof v === 'string') {
                v = v.toUpperCase(); // Converte valor para mai√∫sculas se for string
              }
            }
            html += `<tr><th>${k}</th><td>${String(v || '').toUpperCase()}</td></tr>`;
          });

          html += `
                </table>
              </div>
              <div class="modal-actions">
                <button class="btn-download btn-cancel">FECHAR</button>
              </div>
            </div>`;

          modal.innerHTML = html;
          document.body.appendChild(modal);

          // Handle close via X button or backdrop click
          const close = () => {
            modal.remove();
          };

          modal.querySelector('.btn-close').addEventListener('click', close);
          modal.querySelector('.btn-cancel').addEventListener('click', close);
          modal.addEventListener('click', e => {
            if (e.target === modal) close();
          });
        }

        // Attach handlers for Ver buttons (show preview modal first)
        function attachVerHandlers(insArray) {
          document.querySelectorAll('.verIns').forEach(btn => btn.addEventListener('click', (e)=>{
            const idx = Number(btn.getAttribute('data-idx'));
            const obj = insArray[idx];
            if (!obj) return alert('Registro n√£o encontrado');
            showInscricaoPreview(obj);
          }));
        }
      }

      function renderContatos(arr){
        if (!Array.isArray(arr) || arr.length === 0) {
          contentEl.innerHTML = `<div class="card">
            <h2 class="section-title">üìß Contatos</h2>
            <p style="color:#999;text-align:center;padding:2rem 0">Nenhum contato registrado no momento.</p>
          </div>`;
          return;
        }
        
        // An√°lise dos contatos
        const assuntos = {};
        arr.forEach(c => {
          const ass = c.assunto || c.subject || 'Sem assunto';
          assuntos[ass] = (assuntos[ass] || 0) + 1;
        });

        let html = `<div class="card">
          <div class="section-header">
            <div>
              <h2 class="section-title">üìß Contatos</h2>
              <p class="section-stats">${arr.length} ${arr.length === 1 ? 'contato' : 'contatos'} registrado${arr.length === 1 ? '' : 's'}</p>
            </div>
            <button id="clearContBtn" class="btn-delete" style="padding:0.6rem 1rem">
              üóëÔ∏è Limpar todos
            </button>
          </div>
          
          <div class="search-filter">
            <input type="text" id="searchContatos" class="search-input" placeholder="üîç Buscar contatos por nome, email ou telefone...">
          </div>
          
          <div class="cards-grid" id="contatosGrid"></div>
        </div>`;
        
        contentEl.innerHTML = html;
        const grid = document.getElementById('contatosGrid');
        const searchInput = document.getElementById('searchContatos');
        
        function renderCards(items) {
          if (items.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:#999">Nenhum resultado encontrado</div>';
            return;
          }
          
          grid.innerHTML = items.map((item, filteredIdx) => {
            // Encontra o √≠ndice original no array completo
            const originalIdx = arr.findIndex(orig => orig === item);
            const nome = item.nome || item.name || 'Sem nome';
            const email = item.email || '-';
            const telefone = item.telefone || item.phone || item.whatsapp || '-';
            const assunto = item.assunto || item.subject || '-';
            const dataCriacao = item.receivedAt ? new Date(Number(item.receivedAt)).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '-';
            const mensagem = item.mensagem || item.message || '';
            const resumoMsg = mensagem.length > 100 ? mensagem.substring(0, 100) + '...' : mensagem;
            
            return `
              <div class="data-card contact">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem;padding-bottom:0.75rem;border-bottom:2px solid #00b37a">
                  <div style="font-weight:600;font-size:1.05rem;color:#333">${nome}</div>
                  <div style="background:#e8f5f0;color:#00b37a;padding:0.25rem 0.75rem;border-radius:4px;font-size:0.8rem;font-weight:500">${dataCriacao}</div>
                </div>
                <div class="card-field">
                  <div class="card-field-label">üìå Assunto</div>
                  <div class="card-field-value" style="font-weight:500;color:#0b3a91">${assunto}</div>
                </div>
                <div class="card-field">
                  <div class="card-field-label">üìß Email</div>
                  <div class="card-field-value"><a href="mailto:${email}" style="color:#00b37a;text-decoration:none;word-break:break-all">${email}</a></div>
                </div>
                <div class="card-field">
                  <div class="card-field-label">üì± Telefone</div>
                  <div class="card-field-value"><a href="tel:${telefone}" style="color:#0b3a91;text-decoration:none">${telefone}</a></div>
                </div>
                ${resumoMsg ? `<div class="card-field">
                  <div class="card-field-label">üí¨ Mensagem</div>
                  <div class="card-field-value" style="font-size:0.9rem;color:#666;line-height:1.4;max-height:80px;overflow-y:auto">${resumoMsg}</div>
                </div>` : ''}
                <div class="card-actions">
                  <button data-idx="${originalIdx}" class="verCont" style="flex:1;background:#0b5cff">Ver Completo</button>
                  <button data-idx="${originalIdx}" class="delCont" style="flex:1;background:#dc2626">üóëÔ∏è Excluir</button>
                </div>
              </div>
            `;
          }).join('');
          
          // Reattach event handlers
          document.querySelectorAll('.verCont').forEach(btn => btn.addEventListener('click', viewContato));
          document.querySelectorAll('.delCont').forEach(btn => btn.addEventListener('click', deleteContato));
        }
        
        function viewContato(e) {
          const idx = Number(e.currentTarget.getAttribute('data-idx'));
          const item = arr[idx];
          if (!item) return alert('Contato n√£o encontrado');
          
          const nome = item.nome || item.name || 'Sem nome';
          const email = item.email || '';
          const telefone = item.telefone || item.phone || item.whatsapp || '';
          const assunto = item.assunto || item.subject || '';
          const mensagem = item.mensagem || item.message || '';
          const dataCriacao = item.receivedAt ? new Date(Number(item.receivedAt)).toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }) : '-';
          
          // Modal para impress√£o em formato A4
          const modal = document.createElement('div');
          modal.className = 'modal-overlay';
          modal.innerHTML = `
            <div class="modal-content" style="max-width:900px;background:#fff">
              <div class="modal-header">
                <h2 style="margin:0;font-size:1.3rem">üìß DETALHES DO CONTATO</h2>
                <button class="btn-close">&times;</button>
              </div>
              <div class="modal-body">
                <div style="background:#f5f5f5;padding:2rem;border-radius:8px;font-family:'Courier New',monospace">
                  <div style="display:grid;gap:1.5rem;min-height:500px">
                    <div style="border-bottom:2px solid #00b37a;padding-bottom:1rem">
                      <h3 style="margin:0 0 0.5rem 0;color:#00b37a;font-size:0.9rem;text-transform:uppercase;letter-spacing:1px">üë§ Nome</h3>
                      <div style="font-size:1.3rem;font-weight:bold;color:#333">${nome}</div>
                    </div>
                    
                    <div style="border-bottom:2px solid #00b37a;padding-bottom:1rem">
                      <h3 style="margin:0 0 0.5rem 0;color:#00b37a;font-size:0.9rem;text-transform:uppercase;letter-spacing:1px">üìß Email</h3>
                      <div style="font-size:1rem;color:#0b5cff;word-break:break-all">${email}</div>
                    </div>
                    
                    <div style="border-bottom:2px solid #00b37a;padding-bottom:1rem">
                      <h3 style="margin:0 0 0.5rem 0;color:#00b37a;font-size:0.9rem;text-transform:uppercase;letter-spacing:1px">üì± Telefone</h3>
                      <div style="font-size:1.1rem;color:#333">${telefone}</div>
                    </div>
                    
                    <div style="border-bottom:2px solid #00b37a;padding-bottom:1rem">
                      <h3 style="margin:0 0 0.5rem 0;color:#00b37a;font-size:0.9rem;text-transform:uppercase;letter-spacing:1px">üìå Assunto</h3>
                      <div style="font-size:1rem;color:#333;font-weight:500">${assunto}</div>
                    </div>
                    
                    <div style="border-bottom:2px solid #00b37a;padding-bottom:1rem">
                      <h3 style="margin:0 0 0.5rem 0;color:#00b37a;font-size:0.9rem;text-transform:uppercase;letter-spacing:1px">üïê Data de Recebimento</h3>
                      <div style="font-size:0.95rem;color:#666">${dataCriacao}</div>
                    </div>
                    
                    <div style="padding-bottom:1rem;flex:1;display:flex;flex-direction:column">
                      <h3 style="margin:0 0 0.5rem 0;color:#00b37a;font-size:0.9rem;text-transform:uppercase;letter-spacing:1px">üí¨ Mensagem Completa</h3>
                      <div style="font-size:0.95rem;color:#333;line-height:1.6;white-space:pre-wrap;word-break:break-word;flex:1;background:#fff;padding:1rem;border-radius:6px;border:1px solid #ddd">${mensagem}</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-actions">
                <button style="background:#0b5cff;color:#fff;border:none;padding:0.6rem 1.5rem;border-radius:6px;cursor:pointer" onclick="window.print()">üñ®Ô∏è Imprimir</button>
                <button style="background:#00b37a;color:#fff;border:none;padding:0.6rem 1.5rem;border-radius:6px;cursor:pointer" onclick="window.open('mailto:${email}')">‚úâÔ∏è Responder</button>
                <button class="btn-cancel">Fechar</button>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          const close = () => modal.remove();
          modal.querySelector('.btn-close').addEventListener('click', close);
          modal.querySelector('.btn-cancel').addEventListener('click', close);
          modal.addEventListener('click', e => {
            if (e.target === modal) close();
          });
          
          // Estilos de impress√£o
          const style = document.createElement('style');
          style.innerHTML = `
            @media print {
              body * { display: none; }
              .modal-overlay * { display: block !important; }
              .modal-content { box-shadow: none; width: 100%; max-width: 100%; }
              .modal-header, .modal-actions { display: none; }
              .modal-body { padding: 0; }
            }
          `;
          document.head.appendChild(style);
        }
        
        renderCards(arr);
        
        searchInput.addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase();
          const filtered = arr.filter(item => {
            const nome = (item.nome || item.name || '').toLowerCase();
            const email = (item.email || '').toLowerCase();
            const telefone = (item.telefone || item.phone || item.whatsapp || '').toLowerCase();
            return nome.includes(term) || email.includes(term) || telefone.includes(term);
          });
          renderCards(filtered);
        });
        
        async function deleteContato(e) {
          const idx = Number(e.currentTarget.getAttribute('data-idx'));
          const nome = arr[idx].nome || arr[idx].name || 'Contato';
          
          if (!confirm(`‚ö†Ô∏è Deseja excluir o contato de ${nome}?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
            return;
          }
          
          try {
            const r = await fetch('/api/admin/contatos/delete', {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ index: idx })
            });
            
            if (!r.ok) {
              const errData = await r.json().catch(() => ({ error: 'Erro ao deletar' }));
              throw new Error(errData.error || `Erro ${r.status}`);
            }
            
            alert('‚úÖ Contato exclu√≠do com sucesso');
            document.getElementById('btnCont').click();
          } catch (err) {
            console.error('Erro ao deletar contato:', err);
            alert('‚ùå Erro: ' + err.message);
          }
        }
        
        document.getElementById('clearContBtn').addEventListener('click', async ()=>{
          const total = arr.length;
          if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ est√° prestes a APAGAR TODOS OS ${total} ${total === 1 ? 'CONTATO' : 'CONTATOS'}!\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
            return;
          }
          
          const confirmText = prompt('Para confirmar, digite CONFIRMAR em mai√∫sculas:');
          if (confirmText !== 'CONFIRMAR') {
            alert('‚ùå Opera√ß√£o cancelada!');
            return;
          }
          
          try{
            const r = await fetch('/api/admin/contatos/clear', { method: 'POST', credentials: 'include' });
            if (!r.ok) throw new Error('Falha ao limpar os contatos');
            alert(`‚úÖ ${total} ${total === 1 ? 'contato foi' : 'contatos foram'} removido(s) com sucesso`);
            document.getElementById('btnCont').click();
          }catch(e){ 
            alert('‚ùå Erro: ' + e.message); 
          }
        });
      }

      function renderContratacoes(arr){
        if (!Array.isArray(arr) || arr.length === 0) {
          contentEl.innerHTML = `<div class="card">
            <h2 class="section-title">üé≠ Contrata√ß√µes</h2>
            <p style="color:#999;text-align:center;padding:2rem 0">Nenhuma contrata√ß√£o registrada no momento.</p>
          </div>`;
          return;
        }
        
        let html = `<div class="card">
          <div class="section-header">
            <div>
              <h2 class="section-title">üé≠ Contrata√ß√µes</h2>
              <p class="section-stats">${arr.length} contrata${arr.length === 1 ? '√ß√£o' : '√ß√µes'} registrada${arr.length === 1 ? '' : 's'}</p>
            </div>
            <button id="clearConrBtn" class="btn-delete" style="padding:0.6rem 1rem">
              üóëÔ∏è Limpar todos
            </button>
          </div>
          
          <div class="search-filter">
            <input type="text" id="searchContratacoes" class="search-input" placeholder="üîç Buscar por artista, grupo ou tipo de servi√ßo...">
          </div>
          
          <div class="cards-grid" id="contratcoesGrid"></div>
        </div>`;
        
        contentEl.innerHTML = html;
        const grid = document.getElementById('contratcoesGrid');
        const searchInput = document.getElementById('searchContratacoes');
        
        function renderCards(items) {
          if (items.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:#999">Nenhum resultado encontrado</div>';
            return;
          }
          
          grid.innerHTML = items.map((item, filteredIdx) => {
            // Encontra o √≠ndice original no array completo
            const originalIdx = arr.findIndex(orig => orig === item);
            const nomeContratante = item.nomeContratante || item.nome || '-';
            const emailContratante = item.emailContratante || item.email || '-';
            const telefoneContratante = item.telefoneContratante || item.telefone || '-';
            const dataEvento = item.dataEvento || item.data || '-';
            const localEvento = item.localEvento || item.local || '-';
            const detalhesEvento = item.detalhesEvento || item.detalhes || '-';
            const dataCriacao = item.receivedAt ? new Date(Number(item.receivedAt)).toLocaleDateString('pt-BR') : '-';
            
            return `
              <div class="data-card contractor">
                <div class="card-field">
                  <div class="card-field-label">üë§ Nome do Contratante</div>
                  <div class="card-field-value">${nomeContratante}</div>
                </div>
                <div class="card-field">
                  <div class="card-field-label">üìß E-mail</div>
                  <div class="card-field-value"><a href="mailto:${emailContratante}" style="color:#ff7a00;text-decoration:none">${emailContratante}</a></div>
                </div>
                <div class="card-field">
                  <div class="card-field-label">üì± Telefone</div>
                  <div class="card-field-value"><a href="tel:${telefoneContratante}" style="color:#ff7a00;text-decoration:none">${telefoneContratante}</a></div>
                </div>
                <div class="card-field">
                  <div class="card-field-label">üìÖ Data do Evento</div>
                  <div class="card-field-value">${dataEvento}</div>
                </div>
                <div class="card-field">
                  <div class="card-field-label">üìç Local do Evento</div>
                  <div class="card-field-value">${localEvento}</div>
                </div>
                <div class="card-field">
                  <div class="card-field-label">üìù Detalhes do Evento</div>
                  <div class="card-field-value" style="max-height:120px;overflow-y:auto">${detalhesEvento}</div>
                </div>
                <div class="card-field">
                  <div class="card-field-label">üïê Registrado em</div>
                  <div class="card-field-value">${dataCriacao}</div>
                </div>
                <div class="card-actions">
                  <button data-idx="${originalIdx}" class="verContr" style="flex:1;background:#ff7a00">Ver</button>
                  <button data-idx="${originalIdx}" class="delContr" style="flex:1;background:#dc2626">üóëÔ∏è Excluir</button>
                </div>
              </div>
            `;
          }).join('');
          
          // Reattach delete handlers and view handlers
          document.querySelectorAll('.delContr').forEach(btn => btn.addEventListener('click', deleteContratacao));
          document.querySelectorAll('.verContr').forEach(btn => btn.addEventListener('click', viewContratacao));
        }
        
        renderCards(arr);
        
        searchInput.addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase();
          const filtered = arr.filter(item => {
            const nomeContratante = (item.nomeContratante || item.nome || '').toLowerCase();
            const emailContratante = (item.emailContratante || item.email || '').toLowerCase();
            const telefoneContratante = (item.telefoneContratante || item.telefone || '').toLowerCase();
            const dataEvento = (item.dataEvento || item.data || '').toLowerCase();
            const localEvento = (item.localEvento || item.local || '').toLowerCase();
            return nomeContratante.includes(term) || emailContratante.includes(term) || telefoneContratante.includes(term) || dataEvento.includes(term) || localEvento.includes(term);
          });
          renderCards(filtered);
        });
        
        // Bot√£o de limpar todas as contrata√ß√µes
        const clearConrBtn = document.getElementById('clearConrBtn');
        console.log('[CONTRATA√á√ïES CARDS] clearConrBtn:', clearConrBtn);
        if (clearConrBtn) {
          clearConrBtn.addEventListener('click', async ()=>{
            const total = arr.length;
            if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ est√° prestes a APAGAR TODAS AS ${total} ${total === 1 ? 'CONTRATA√á√ÉO' : 'CONTRATA√á√ïES'}!\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
              return;
            }
            
            const confirmText = prompt('Para confirmar, digite CONFIRMAR em mai√∫sculas:');
            if (confirmText !== 'CONFIRMAR') {
              alert('‚ùå Opera√ß√£o cancelada!');
              return;
            }
            
            try{
              const r = await fetch('/api/admin/contratacoes/clear', { method: 'POST', credentials: 'include' });
              if (!r.ok) throw new Error('Falha ao limpar as contrata√ß√µes');
              alert(`‚úÖ ${total} ${total === 1 ? 'contrata√ß√£o foi' : 'contrata√ß√µes foram'} removida(s) com sucesso`);
              document.getElementById('btnConr').click();
            }catch(e){ 
              alert('‚ùå Erro: ' + e.message); 
            }
          });
        }
        
        
        async function viewContratacao(e) {
          const idx = Number(e.currentTarget.getAttribute('data-idx'));
          const item = arr[idx];
          const nomeContratante = item.nomeContratante || item.nome || '-';
          const emailContratante = item.emailContratante || item.email || '-';
          const telefoneContratante = item.telefoneContratante || item.telefone || '-';
          const dataEvento = item.dataEvento || item.data || '-';
          const localEvento = item.localEvento || item.local || '-';
          const detalhesEvento = item.detalhesEvento || item.detalhes || '-';
          const dataCriacao = item.receivedAt ? new Date(Number(item.receivedAt)).toLocaleDateString('pt-BR') : '-';
          
          const printWindow = window.open('', '', 'height=800,width=600');
          const doc = printWindow.document;
          doc.write('<!DOCTYPE html><html><head><meta charset="UTF-8">');
          doc.write('<title>Solicitacao de Contratacao</title>');
          doc.write('<style>body{font-family:Arial;margin:0;padding:20px}');
          doc.write('.container{max-width:210mm;height:297mm;margin:0 auto;padding:20mm;background:white}');
          doc.write('h1{text-align:center;color:#ff7a00;border-bottom:3px solid #ff7a00;padding-bottom:10px}');
          doc.write('.field{margin:15px 0}.field-label{font-weight:bold;color:#333;font-size:12px}');
          doc.write('.field-value{color:#666;font-size:13px;padding:8px;background:#f5f5f5;border-left:3px solid #ff7a00;padding-left:10px}');
          doc.write('.print-button{text-align:center;margin:20px 0}');
          doc.write('.print-button button{padding:10px 20px;background:#ff7a00;color:white;border:none;border-radius:5px;cursor:pointer;font-size:16px}');
          doc.write('.print-button button:hover{background:#e67e00}');
          doc.write('@media print{body{margin:0;padding:0}.container{box-shadow:none;height:auto}.print-button{display:none}}');
          doc.write('</style></head><body><div class="container">');
          doc.write('<h1>Solicitacao de Contratacao</h1>');
          doc.write('<div class="field"><div class="field-label">Nome do Contratante</div><div class="field-value">' + nomeContratante + '</div></div>');
          doc.write('<div class="field"><div class="field-label">Email</div><div class="field-value">' + emailContratante + '</div></div>');
          doc.write('<div class="field"><div class="field-label">Telefone</div><div class="field-value">' + telefoneContratante + '</div></div>');
          doc.write('<div class="field"><div class="field-label">Data do Evento</div><div class="field-value">' + dataEvento + '</div></div>');
          doc.write('<div class="field"><div class="field-label">Local do Evento</div><div class="field-value">' + localEvento + '</div></div>');
          doc.write('<div class="field"><div class="field-label">Detalhes do Evento</div><div class="field-value">' + detalhesEvento.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div></div>');
          doc.write('<div class="field"><div class="field-label">Registrado em</div><div class="field-value">' + dataCriacao + '</div></div>');
          doc.write('<div class="print-button"><button onclick="window.print()">Imprimir</button></div>');
          doc.write('</div></body></html>');
          doc.close();
        }
        
        async function deleteContratacao(e) {
          const idx = Number(e.currentTarget.getAttribute('data-idx'));
          const nomeContratante = arr[idx].nomeContratante || arr[idx].nome || 'Contrata√ß√£o';
          
          if (!confirm(`‚ö†Ô∏è Deseja excluir a contrata√ß√£o de ${nomeContratante}?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
            return;
          }
          
          try {
            const r = await fetch('/api/admin/contratacoes/delete', {
              method: 'DELETE',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ index: idx })
            });
            
            if (!r.ok) {
              const errData = await r.json().catch(() => ({ error: 'Erro ao deletar' }));
              throw new Error(errData.error || `Erro ${r.status}`);
            }
            
            alert('‚úÖ Contrata√ß√£o exclu√≠da com sucesso');
            document.getElementById('btnConr').click();
          } catch (err) {
            console.error('Erro ao deletar contrata√ß√£o:', err);
            alert('‚ùå Erro: ' + err.message);
          }
        }
      }

    // Bot√µes de carregar dados (defensivo: s√≥ adiciona listeners se o elemento existir)
    const btnInsEl = document.getElementById('btnIns');
    if (btnInsEl) btnInsEl.addEventListener('click', async ()=> {
      try{ const data = await fetchJson('/api/admin/inscricoes'); renderInscricoes(data); }
      catch(e){ alert('‚ùå Erro ao carregar inscri√ß√µes: ' + e.message); }
    });

    const btnContEl = document.getElementById('btnCont');
    if (btnContEl) btnContEl.addEventListener('click', async ()=> {
      try{ const data = await fetchJson('/api/admin/contatos'); renderContatos(data); }
      catch(e){ alert('‚ùå Erro ao carregar contatos: ' + e.message); }
    });

    const btnConrEl = document.getElementById('btnConr');
    if (btnConrEl) btnConrEl.addEventListener('click', async ()=> {
      try{ const data = await fetchJson('/api/admin/contratacoes'); renderContratacoes(data); }
      catch(e){ alert('‚ùå Erro ao carregar contrata√ß√µes: ' + e.message); }
    });

    // Bot√£o de limpar contatos (nem sempre presente)
    const btnClearCttEl = document.getElementById('btnClearCtt');
    if (btnClearCttEl) btnClearCttEl.addEventListener('click', async ()=> {
      try {
        const data = await fetchJson('/api/admin/contatos');
        if (!Array.isArray(data) || data.length === 0) {
          alert('‚ÑπÔ∏è N√£o h√° contatos para limpar.');
          return;
        }

        const total = data.length;
        
        // Primeiro alerta com detalhes da opera√ß√£o
        const msg = `‚ö†Ô∏è ATEN√á√ÉO! Opera√ß√£o Destrutiva!\n\n`
          + `Voc√™ est√° prestes a APAGAR TODOS OS ${total} ${total === 1 ? 'CONTATO' : 'CONTATOS'}!\n\n`
          + `Esta a√ß√£o:\n`
          + `- N√£o pode ser desfeita\n`
          + `- Apagar√° PERMANENTEMENTE todos os contatos\n`
          + `- N√£o h√° backup autom√°tico\n\n`
          + `Quantidade de registros: ${total}\n\n`
          + `Tem certeza absoluta que deseja continuar?`;
        
        if (!confirm(msg)) {
          alert('‚ùå Opera√ß√£o cancelada!\nNenhum contato foi removido.');
          return;
        }
        
        // Solicita digita√ß√£o de CONFIRMAR
        const confirmText = prompt(
          '‚ö†Ô∏è √öltima chance!\n\n'
          + 'Para confirmar a exclus√£o, digite CONFIRMAR\n'
          + '(exatamente como mostrado, em mai√∫sculas):'
        );
        
        // Remove espa√ßos e verifica se digitou exatamente CONFIRMAR
        const userInput = (confirmText || '').trim().toUpperCase();
        if (userInput !== 'CONFIRMAR') {
          alert('‚ùå Opera√ß√£o cancelada!\nNenhum contato foi removido.\n\n'
            + 'Motivo: O texto digitado n√£o corresponde a "CONFIRMAR".');
          return;
        }

        // Se chegou aqui, executa a limpeza
        const r = await fetch('/api/admin/contatos/clear', { 
          method: 'POST', 
          credentials: 'include' 
        });
        if (!r.ok) throw new Error('Falha ao limpar os contatos');
        alert(`‚úÖ Sucesso!\n\n${total} ${total === 1 ? 'contato foi removido' : 'contatos foram removidos'} com sucesso.`);
        document.getElementById('btnCont').click();
      } catch(e) { 
        alert('‚ùå Erro ao limpar contatos!\n\n' + e.message + '\n\nNenhum contato foi removido.'); 
      }
    });

    // Bot√£o de Sair
    document.getElementById('btnLogout').addEventListener('click', async ()=> {
      if (!confirm('üîê Sair do Painel Admin?\n\nVoc√™ precisar√° fazer login novamente para acessar.')) {
        return;
      }
      try { 
        await fetch('/api/admin/logout', { 
          method: 'POST',
          credentials: 'include'
        });
      } catch(e) { 
        console.error('Erro ao fazer logout:', e);
      } finally {
        // server-side session will be destroyed by the API; redirect to login
        window.location.href = '/admin-login.html';
      }
    });

    // auto-load inscriptions on open
    (async ()=>{ try{ const data = await fetchJson('/api/admin/inscricoes'); renderInscricoes(data);}catch(e){ /* ignore */ } })();
  </script>
  <script src="admin.js" defer></script>
</body>
</html>