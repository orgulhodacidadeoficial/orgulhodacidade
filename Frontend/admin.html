<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Inscri√ß√µes</title>
  <style>
    body{font-family:Inter,Arial,sans-serif;margin:0;background:#f7f8fb;color:#111;-webkit-text-size-adjust:100%;overflow-x:hidden}
    header{background:#0b3a91;color:#fff;padding:0.75rem 1rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.75rem}
    header h1{font-size:1.1rem;margin:0}
    .wrap{max-width:1200px;margin:0.5rem auto;padding:0.75rem}
    .row{display:flex;gap:1rem;flex-wrap:wrap}
    .compact-list{display:flex;flex-direction:column;gap:1rem}
    .inscricao-compact{background:#fff;border-radius:8px;padding:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
    .compact-row{margin-bottom:0.5rem}
    .compact-datetime{color:#666;font-size:0.85rem;margin-bottom:0.25rem}
    .compact-name{font-weight:600;font-size:1.1rem;margin-bottom:0.25rem}
    .compact-part{color:#0b5cff;font-weight:500;text-transform:capitalize}
    .detail-row{display:grid;grid-template-columns:140px 1fr;gap:0.5rem;padding:0.5rem 0;border-bottom:1px solid #eee}
    .detail-row:last-child{border:none}
    .detail-row strong{color:#555;font-size:0.9rem}
    @media (max-width: 768px) {
      header{padding:0.5rem;gap:0.5rem}
      header h1{width:100%;margin-bottom:0.5rem;font-size:1rem}
      .controls{width:100%;overflow-x:auto;padding-bottom:0.25rem}
      .controls::-webkit-scrollbar{height:3px}
      .controls::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2)}
      .wrap{padding:0.5rem;margin:0}
    }
    /* Modal styles */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000;padding:0.5rem}
    .modal-content{background:#fff;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.15);width:92%;max-width:800px;max-height:90vh;overflow-y:auto;position:relative}
    .modal-header{padding:1rem;border-bottom:1px solid #eee;position:sticky;top:0;background:#fff;display:flex;justify-content:space-between;align-items:center;z-index:1}
    .modal-body{padding:1.5rem}
    .modal-actions{padding:1rem;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:0.75rem}
    .btn-close{position:absolute;right:0.75rem;top:0.75rem;background:none;border:none;font-size:1.5rem;cursor:pointer;padding:0.25rem;line-height:1}
    .preview-table{width:100%;border-collapse:collapse;margin:0.5rem 0}
    .preview-table th{text-align:left;background:#f5f5f5;font-weight:600;width:180px}
    .preview-table th,.preview-table td{padding:0.6rem;border:1px solid #ddd;vertical-align:top}
    .btn-download{background:#0b5cff;color:#fff;border:none;padding:0.6rem 1rem;border-radius:6px;cursor:pointer;font-size:0.95rem}
    .btn-cancel{background:#f3f3f3;color:#666;border:1px solid #ddd}
    @media (max-width: 768px) {
      .modal-overlay{padding:0}
      .modal-content{width:100%;height:100%;max-height:100vh;border-radius:0}
      .modal-header{padding:0.75rem}
      .modal-body{padding:0.75rem}
      .modal-actions{padding:0.75rem;gap:0.5rem;flex-wrap:wrap}
      .preview-table{font-size:0.9rem}
      .preview-table th{width:110px;white-space:nowrap}
      .preview-table th,.preview-table td{padding:0.5rem;font-size:0.9rem}
      .btn-download,.btn-cancel{width:100%;padding:0.75rem;font-size:0.95rem;text-align:center}
    }
    .card{background:#fff;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.06);padding:1.25rem;flex:1;min-width:300px;margin-top:1rem}
    table{width:100%;border-collapse:collapse;font-size:0.95rem}
    th{padding:0.75rem;border-bottom:2px solid #ddd;text-align:left;font-weight:600;color:#444}
    td{padding:0.75rem;border-bottom:1px solid #eee;text-align:left}
    td pre{margin:0;font-family:inherit;font-size:inherit}
    tr:hover{background:#f8f9ff}
    .controls{display:flex;gap:0.5rem}
    button{background:#0046ad;color:#fff;border:none;padding:0.45rem 0.6rem;border-radius:6px;cursor:pointer;white-space:nowrap;font-size:0.9rem}
    .logout{background:#c33}
    pre{white-space:pre-wrap;word-break:break-word}
    @media (max-width: 768px) {
      .card{padding:0.75rem;border-radius:6px;margin-top:0.75rem}
      table{font-size:0.85rem}
      th,td{padding:0.4rem}
      button{padding:0.4rem 0.5rem;font-size:0.85rem}
      #btnRelatorio{font-size:0.85rem}
    }
  </style>
  <!-- √çcones do site (favicon) -->
  <link rel="icon" type="image/png" sizes="32x32" href="logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="logo.png">
  <link rel="shortcut icon" href="logo.png" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="180x180" href="logo.png">
  <meta name="theme-color" content="#ff8a00">
</head>
<body>
  <header>
    <h1>Painel Administrativo</h1>
    <div class="controls">
      <button id="btnHome" onclick="window.location.href='index.html'" style="background:#e00606;">Ir para o Site</button>
      <button id="btnIns">Carregar Inscri√ß√µes</button>
      <button id="btnCont">Carregar Contatos</button>
      <button id="btnConr">Carregar Contrata√ß√µes</button>
      
      <button id="btnLogout" class="logout">Sair</button>
    </div>
  </header>

   
  <div class="wrap">
    <div id="content"></div>
  </div>

  <script>
    const contentEl = document.getElementById('content');
    async function fetchJson(url){
      const r = await fetch(url, { credentials: 'include' });
      if (!r.ok) throw new Error('Falha ao carregar');
      return r.json();
    }

  // render inscri√ß√µes with a chart by tipo_participacao
  // On mobile/tablet we show a compact list (date/time, name, participation)
  // with a per-person expandable details panel to keep the admin list readable.
  function renderInscricoes(arr){
        if (!Array.isArray(arr) || arr.length === 0) {
          contentEl.innerHTML = `<div class="card"><h3>Inscri√ß√µes</h3><p>Nenhum registro encontrado.</p></div>`;
          return;
        }

        // preserve original indices so deletes map to file order
        const withIndex = arr.map((v, i) => Object.assign({}, v, { _origIndex: i }));

        // sort by receivedAt (timestamp) desc
        const sorted = withIndex.slice().sort((a, b) => (b.receivedAt || 0) - (a.receivedAt || 0));

        // count types for chart
        const counts = {};
        sorted.forEach(item => {
          const t = (item.tipo_participacao || 'Outros').toString();
          counts[t] = (counts[t] || 0) + 1;
        });

        // build html with canvas for chart and either a table (desktop)
        // or a compact list (tablet/mobile). We detect viewport width here.
        const isCompact = window.matchMedia('(max-width: 1024px)').matches;

        let html = `<div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
            <h3>Inscri√ß√µes por Tipo</h3>
            <button id="btnRelatorio" style="background:#0046ad">üìã Gerar Relat√≥rio</button>
          </div>
          <div style="height:120px"><canvas id="insChart"></canvas></div><hr>`;

        // Build either a full table (desktop) or a compact list (mobile/tablet)
        if (!isCompact) {
          // Desktop/tablet-large: show full table
          const keys = new Set();
          withIndex.forEach(v => Object.keys(v).forEach(k => keys.add(k)));
          // Remove specific fields from desktop view
          keys.delete('receivedAt');
          keys.delete('_origIndex');
          keys.delete('ip');
          keys.delete('email');
          const otherKeys = Array.from(keys);

          html += `<div class="table-responsive"><table><thead><tr><th>Recebido</th>`;
          otherKeys.forEach(h=> html += `<th>${h}</th>`);
          html += `<th>A√ß√µes</th></tr></thead><tbody>`;

          sorted.forEach(item => {
            html += '<tr>';
            const ts = item.receivedAt ? new Date(Number(item.receivedAt)).toLocaleString('pt-BR', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            }) : '';
            html += `<td><pre>${ts}</pre></td>`;
            otherKeys.forEach(h=>{
              let v = item[h];
              if (v === undefined) v = '';
              if (typeof v === 'object') v = JSON.stringify(v);
              if (h === 'nome') {
                v = String(v).toUpperCase();
              } else if (h === 'bairro') {
                v = String(v).toUpperCase();
              } else if (h === 'tipo_participacao') {
                v = String(v).toLowerCase();
                v = v.charAt(0).toUpperCase() + v.slice(1);
              }
              if (h === 'telefone') {
                v = `üì± ${v}`;
              }
              html += `<td><pre>${String(v)}</pre></td>`;
            });
            // actions: View (Word) + Delete
            html += `<td style="white-space:nowrap">`;
            html += `<button data-idx="${item._origIndex}" class="verIns" style="background:#0b5cff;margin-right:6px">üìÑ Ver</button>`;
            html += `<button data-idx="${item._origIndex}" class="delIns" style="background:#dc2626">üóëÔ∏è</button>`;
            html += `</td>`;
            html += '</tr>';
          });
          html += `</tbody></table></div></div>`;
        } else {
          // Compact list for mobile/tablet: show minimal fields with expandable details
          html += `<div class="compact-list">`;
          sorted.forEach(item => {
            const ts = item.receivedAt ? new Date(Number(item.receivedAt)) : null;
            const datetime = ts ? new Date(ts).toLocaleString('pt-BR', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            }) : '';
            const nome = (item.nome || '-').toUpperCase();
            const idade = item.idade || item.age || '-';
            const part = (item.tipo_participacao || '-').toLowerCase();
            const telefone = item.telefone || item.phone || '-';
            const bairro = (item.bairro || '-').toLowerCase();
            const orig = item._origIndex;
            
            html += `
              <div class="inscricao-compact" data-idx="${orig}">
                <div class="compact-row">
                  <div class="compact-datetime">${datetime}</div>
                  <div class="compact-name">${nome} ${idade ? (' | ' + idade) : ''}</div>
                  <div class="compact-part">${part}</div>
                </div>
                <div style="display:flex;justify-content:space-between;margin-top:0.75rem;">
                  <div style="font-size:0.95rem;color:#444">
                    <div style="white-space:nowrap;margin-bottom:0.25rem">üì± ${telefone}</div>
                    <div style="color:#444;text-transform:uppercase;font-weight:500">${bairro}</div>
                  </div>
                  <div class="compact-actions" style="display:flex;gap:0.5rem">
                    <button class="verIns" data-idx="${orig}" style="background:#0b5cff;color:#fff">üìÑ Ver</button>
                    <button data-idx="${orig}" class="delIns" style="background:#dc2626">üóëÔ∏è</button>
                  </div>
                </div>
                <div class="inscricao-details" style="display:none;margin-top:0.5rem;">
                  <div class="details-grid">
`;
            // show all other fields inside details
            Object.keys(item).forEach(k => {
              if (k === 'receivedAt' || k === '_origIndex') return;
              let v = item[k];
              if (typeof v === 'object') v = JSON.stringify(v);
              html += `<div class="detail-row"><strong>${k}:</strong> <span>${v || ''}</span></div>`;
            });
            // end of details panel (delete button moved to compact actions)
            html += `
                  </div>
                </div>
              </div>`;
          });
          html += `</div></div>`;
        }
        contentEl.innerHTML = html;

        // attach toggle handlers for compact details
        document.querySelectorAll('.btn-toggle-details').forEach(btn=> btn.addEventListener('click', function(){
          const idx = this.getAttribute('data-idx');
          const el = document.querySelector('.inscricao-compact[data-idx="'+idx+'"] .inscricao-details');
          if (!el) return; el.style.display = (el.style.display === 'none') ? 'block' : 'none';
        }));

        // attach Ver (download Word) handlers
        attachVerHandlers(withIndex);

        

        // attach delete handlers for each inscription
        // Bot√£o de relat√≥rio
        document.getElementById('btnRelatorio').addEventListener('click', () => {
          window.open('/relatorio-inscricoes.html', '_blank');
        });

        // Bot√µes de excluir
        document.querySelectorAll('.delIns').forEach(btn => btn.addEventListener('click', async (e) => {
          const idx = Number(e.currentTarget.getAttribute('data-idx'));
          const row = e.currentTarget.closest('tr');
          let nome = '';
          if (row) {
            nome = row.querySelector('td:nth-child(2) pre') ? row.querySelector('td:nth-child(2) pre').textContent : '';
          } else {
            // compact card
            const card = e.currentTarget.closest('.inscricao-compact');
            if (card) nome = card.querySelector('.compact-name') ? card.querySelector('.compact-name').textContent : '';
          }

          if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ est√° prestes a EXCLUIR esta inscri√ß√£o:\n${nome}\n\nEsta a√ß√£o n√£o pode ser desfeita. Deseja continuar?`)) {
            alert('‚ùå Opera√ß√£o cancelada!');
            return;
          }

          const confirmText = prompt('‚ö†Ô∏è √öltima chance!\n\nPara confirmar a exclus√£o, digite CONFIRMAR (mai√∫sculas):');
          const userInput = (confirmText || '').trim().toUpperCase();
          if (userInput !== 'CONFIRMAR') {
            alert('‚ùå Opera√ß√£o cancelada! Texto n√£o corresponde a "CONFIRMAR".');
            return;
          }

          try {
            const r = await fetch('/api/admin/inscricoes/delete', {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ index: idx })
            });
            if (!r.ok) {
              // try to get error details from response
              let details = '';
              try { const data = await r.json(); details = data && (data.error || JSON.stringify(data)); } catch(e) { try { details = await r.text(); } catch(_) { details = ''; } }
              console.error('Erro ao excluir inscri√ß√£o', r.status, details);
              // give helpful message to the admin (401 => not authenticated)
              if (r.status === 401) throw new Error('N√£o autorizado. Fa√ßa login novamente.');
              throw new Error((details && details.toString()) || ('Status ' + r.status));
            }
            alert('‚úÖ Inscri√ß√£o exclu√≠da com sucesso');
            document.getElementById('btnIns').click();
          } catch (err) {
            console.error(err);
            alert('‚ùå Erro ao excluir inscri√ß√£o!\n\n' + err.message + '\n\nVerifique o console do servidor para mais detalhes.');
          }
        }));

        // load Chart.js from CDN if not present
        (function renderChart(){
          const labels = Object.keys(counts);
          const data = labels.map(l => counts[l]);
          function onceLoaded(){
            try{
              const ctx = document.getElementById('insChart').getContext('2d');
              // eslint-disable-next-line no-undef
              new Chart(ctx, {
                type: 'bar',
                data: {
                  labels,
                  datasets: [{
                    label: 'Quantidade',
                    data,
                    backgroundColor: ['#0b5cff','#ff7a00','#00b37a','#7a3cff']
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    title: { display: false },
                    legend: { display: false },
                    tooltip: { enabled: true }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: { stepSize: 1 }
                    }
                  }
                }
              });
            }catch(e){ console.error('Erro ao renderizar gr√°fico', e); }
          }
          if (window.Chart) return onceLoaded();
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
          s.onload = onceLoaded; s.onerror = ()=>console.warn('N√£o foi poss√≠vel carregar Chart.js');
          document.head.appendChild(s);
        })();

        // Preview inscription data in a modal and offer download
        function showInscricaoPreview(obj) {
          // Create and show modal with preview
          const modal = document.createElement('div');
          modal.className = 'modal-overlay';
          
          const title = (obj.nome || 'Inscri√ß√£o').toString();
          let html = `
            <div class="modal-content">
              <div class="modal-header">
                <h2 style="margin:0;font-size:1.2rem">INSCRI√á√ÉO - ${title.toUpperCase()}</h2>
                <button class="btn-close">&times;</button>
              </div>
              <div class="modal-body">
                <table class="preview-table">`;

          Object.keys(obj).forEach(k => {
            // Skip internal fields and IP
            if (k === '_origIndex' || k === 'ip') return;
            let v = obj[k];
            if (typeof v === 'object') v = JSON.stringify(v, null, 2);
            if (k === 'receivedAt') {
              v = new Date(Number(v)).toLocaleString().toUpperCase();
              k = 'DATA/HORA';
            } else {
              k = k.toUpperCase(); // Converte chave para mai√∫sculas
              if (typeof v === 'string') {
                v = v.toUpperCase(); // Converte valor para mai√∫sculas se for string
              }
            }
            html += `<tr><th>${k}</th><td>${String(v || '').toUpperCase()}</td></tr>`;
          });

          html += `
                </table>
              </div>
              <div class="modal-actions">
                <button class="btn-download btn-cancel">FECHAR</button>
              </div>
            </div>`;

          modal.innerHTML = html;
          document.body.appendChild(modal);

          // Handle close via X button or backdrop click
          const close = () => {
            modal.remove();
          };

          modal.querySelector('.btn-close').addEventListener('click', close);
          modal.querySelector('.btn-cancel').addEventListener('click', close);
          modal.addEventListener('click', e => {
            if (e.target === modal) close();
          });
        }

        // Attach handlers for Ver buttons (show preview modal first)
        function attachVerHandlers(insArray) {
          document.querySelectorAll('.verIns').forEach(btn => btn.addEventListener('click', (e)=>{
            const idx = Number(btn.getAttribute('data-idx'));
            const obj = insArray[idx];
            if (!obj) return alert('Registro n√£o encontrado');
            showInscricaoPreview(obj);
          }));
        }
      }

      function renderContatos(arr){
        if (!Array.isArray(arr) || arr.length === 0) {
          contentEl.innerHTML = `<div class="card">
            <h3>Lista de Contatos</h3>
            <p style="color:#666">Nenhum contato registrado no momento.</p>
          </div>`;
          return;
        }
        const keys = new Set();
        arr.forEach(v => Object.keys(v).forEach(k => keys.add(k)));
        const head = Array.from(keys);
        let html = `<div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
            <h3>Lista de Contatos (${arr.length} ${arr.length === 1 ? 'registro' : 'registros'})</h3>
            <button id="clearContBtn" style="background:#dc2626">
              üóëÔ∏è Limpar todos os contatos
            </button>
          </div>
          <div class="table-responsive"><table><thead><tr>`;
        head.forEach(h=> html += `<th>${h}</th>`);
        html += `</tr></thead><tbody>`;
        arr.forEach(item => {
          html += '<tr>';
          head.forEach(h=>{
            let v = item[h];
            if (v === undefined) v = '';
            if (typeof v === 'object') v = JSON.stringify(v);
            html += `<td><pre>${String(v)}</pre></td>`;
          });
          html += '</tr>';
        });
  html += `</tbody></table></div></div>`;
        contentEl.innerHTML = html;
        document.getElementById('clearContBtn').addEventListener('click', async ()=>{
          const total = arr.length;
          const msg = `‚ö†Ô∏è ATEN√á√ÉO! Opera√ß√£o Destrutiva!\n\n`
            + `Voc√™ est√° prestes a APAGAR TODOS OS ${total} ${total === 1 ? 'CONTATO' : 'CONTATOS'}!\n\n`
            + `Esta a√ß√£o:\n`
            + `- N√£o pode ser desfeita\n`
            + `- Apagar√° PERMANENTEMENTE todos os contatos\n`
            + `- N√£o h√° backup autom√°tico\n\n`
            + `Quantidade de registros: ${total}\n\n`
            + `Tem certeza absoluta que deseja continuar?`;
          
          if (!confirm(msg)) return;
          
          const confirmText = prompt(
            '‚ö†Ô∏è √öltima chance!\n\n'
            + 'Para confirmar a exclus√£o, digite CONFIRMAR em mai√∫sculas:'
          );
          if (confirmText !== 'CONFIRMAR') {
            alert('‚ùå Opera√ß√£o cancelada!\nNenhum contato foi removido.');
            return;
          }
          
          try{
            const r = await fetch('/api/admin/contatos/clear', { method: 'POST', credentials: 'include' });
            if (!r.ok) throw new Error('Falha ao limpar os contatos');
            alert(`‚úÖ Sucesso!\n\n${total} ${total === 1 ? 'contato foi removido' : 'contatos foram removidos'} com sucesso.`);
            document.getElementById('btnCont').click();
          }catch(e){ 
            alert('‚ùå Erro ao limpar contatos!\n\n' + e.message + '\n\nNenhum contato foi removido.'); 
          }
        });
      }

      function renderContratacoes(arr){
        if (!Array.isArray(arr) || arr.length === 0) {
          contentEl.innerHTML = `<div class="card">
            <h3>Lista de Contrata√ß√µes</h3>
            <p style="color:#666">Nenhuma contrata√ß√£o registrada no momento.</p>
          </div>`;
          return;
        }
        const keys = new Set();
        arr.forEach(v => Object.keys(v).forEach(k => keys.add(k)));
        const head = Array.from(keys);
        // add actions column
        let html = `<div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
            <h3>Lista de Contrata√ß√µes (${arr.length} ${arr.length === 1 ? 'registro' : 'registros'})</h3>
          </div>
          <div class="table-responsive"><table><thead><tr>`;
        head.forEach(h=> html += `<th>${h}</th>`);
        html += `<th>A√ß√µes</th></tr></thead><tbody>`;
        arr.forEach((item, idx) => {
          html += '<tr>';
          head.forEach(h=>{
            let v = item[h];
            if (v === undefined) v = '';
            if (typeof v === 'object') v = JSON.stringify(v);
            html += `<td><pre>${String(v)}</pre></td>`;
          });
          html += `<td><button data-idx="${idx}" class="delContr" style="background:#dc2626">üóëÔ∏è Excluir</button></td>`;
          html += '</tr>';
        });
  html += `</tbody></table></div></div>`;
        contentEl.innerHTML = html;
        document.querySelectorAll('.delContr').forEach(btn=> btn.addEventListener('click', async (e)=>{
          const idx = Number(e.currentTarget.getAttribute('data-idx'));
          const row = e.currentTarget.closest('tr');
          const nome = row.querySelector('td:first-child pre').textContent;
          
          // Primeiro alerta com detalhes
          if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ est√° prestes a EXCLUIR a contrata√ß√£o de:\n${nome}\n\nEsta a√ß√£o:\n- N√£o pode ser desfeita\n- Apagar√° permanentemente este registro\n\nTem certeza que deseja continuar?`)) {
            alert('‚ùå Opera√ß√£o cancelada!\nA contrata√ß√£o n√£o foi exclu√≠da.');
            return;
          }

          // Solicita digita√ß√£o de CONFIRMAR
          const confirmText = prompt(
            '‚ö†Ô∏è √öltima chance!\n\n'
            + 'Para confirmar a exclus√£o, digite CONFIRMAR\n'
            + '(exatamente como mostrado, em mai√∫sculas):'
          );
          
          // Remove espa√ßos e verifica se digitou exatamente CONFIRMAR
          const userInput = (confirmText || '').trim().toUpperCase();
          if (userInput !== 'CONFIRMAR') {
            alert('‚ùå Opera√ß√£o cancelada!\nA contrata√ß√£o n√£o foi exclu√≠da.\n\n'
              + 'Motivo: O texto digitado n√£o corresponde a "CONFIRMAR".');
            return;
          }

          try{
            const r = await fetch('/api/admin/contratacoes/delete', { 
              method: 'POST', 
              credentials: 'include', 
              headers: {'Content-Type':'application/json'}, 
              body: JSON.stringify({ index: idx }) 
            });
            if (!r.ok) throw new Error('Falha ao excluir a contrata√ß√£o');
            alert('‚úÖ Contrata√ß√£o exclu√≠da com sucesso');
            document.getElementById('btnConr').click();
          }catch(er){ 
            alert('‚ùå Erro ao excluir contrata√ß√£o!\n\n' + er.message); 
          }
        }));
      }

    // Bot√µes de carregar dados (defensivo: s√≥ adiciona listeners se o elemento existir)
    const btnInsEl = document.getElementById('btnIns');
    if (btnInsEl) btnInsEl.addEventListener('click', async ()=> {
      try{ const data = await fetchJson('/api/admin/inscricoes'); renderInscricoes(data); }
      catch(e){ alert('‚ùå Erro ao carregar inscri√ß√µes: ' + e.message); }
    });

    const btnContEl = document.getElementById('btnCont');
    if (btnContEl) btnContEl.addEventListener('click', async ()=> {
      try{ const data = await fetchJson('/api/admin/contatos'); renderContatos(data); }
      catch(e){ alert('‚ùå Erro ao carregar contatos: ' + e.message); }
    });

    const btnConrEl = document.getElementById('btnConr');
    if (btnConrEl) btnConrEl.addEventListener('click', async ()=> {
      try{ const data = await fetchJson('/api/admin/contratacoes'); renderContratacoes(data); }
      catch(e){ alert('‚ùå Erro ao carregar contrata√ß√µes: ' + e.message); }
    });

    // Bot√£o de limpar contatos (nem sempre presente)
    const btnClearCttEl = document.getElementById('btnClearCtt');
    if (btnClearCttEl) btnClearCttEl.addEventListener('click', async ()=> {
      try {
        const data = await fetchJson('/api/admin/contatos');
        if (!Array.isArray(data) || data.length === 0) {
          alert('‚ÑπÔ∏è N√£o h√° contatos para limpar.');
          return;
        }

        const total = data.length;
        
        // Primeiro alerta com detalhes da opera√ß√£o
        const msg = `‚ö†Ô∏è ATEN√á√ÉO! Opera√ß√£o Destrutiva!\n\n`
          + `Voc√™ est√° prestes a APAGAR TODOS OS ${total} ${total === 1 ? 'CONTATO' : 'CONTATOS'}!\n\n`
          + `Esta a√ß√£o:\n`
          + `- N√£o pode ser desfeita\n`
          + `- Apagar√° PERMANENTEMENTE todos os contatos\n`
          + `- N√£o h√° backup autom√°tico\n\n`
          + `Quantidade de registros: ${total}\n\n`
          + `Tem certeza absoluta que deseja continuar?`;
        
        if (!confirm(msg)) {
          alert('‚ùå Opera√ß√£o cancelada!\nNenhum contato foi removido.');
          return;
        }
        
        // Solicita digita√ß√£o de CONFIRMAR
        const confirmText = prompt(
          '‚ö†Ô∏è √öltima chance!\n\n'
          + 'Para confirmar a exclus√£o, digite CONFIRMAR\n'
          + '(exatamente como mostrado, em mai√∫sculas):'
        );
        
        // Remove espa√ßos e verifica se digitou exatamente CONFIRMAR
        const userInput = (confirmText || '').trim().toUpperCase();
        if (userInput !== 'CONFIRMAR') {
          alert('‚ùå Opera√ß√£o cancelada!\nNenhum contato foi removido.\n\n'
            + 'Motivo: O texto digitado n√£o corresponde a "CONFIRMAR".');
          return;
        }

        // Se chegou aqui, executa a limpeza
        const r = await fetch('/api/admin/contatos/clear', { 
          method: 'POST', 
          credentials: 'include' 
        });
        if (!r.ok) throw new Error('Falha ao limpar os contatos');
        alert(`‚úÖ Sucesso!\n\n${total} ${total === 1 ? 'contato foi removido' : 'contatos foram removidos'} com sucesso.`);
        document.getElementById('btnCont').click();
      } catch(e) { 
        alert('‚ùå Erro ao limpar contatos!\n\n' + e.message + '\n\nNenhum contato foi removido.'); 
      }
    });

    // Bot√£o de Sair
    document.getElementById('btnLogout').addEventListener('click', async ()=> {
      if (!confirm('üîê Sair do Painel Admin?\n\nVoc√™ precisar√° fazer login novamente para acessar.')) {
        return;
      }
      try { 
        await fetch('/api/admin/logout', { 
          method: 'POST',
          credentials: 'include'
        });
      } catch(e) { 
        console.error('Erro ao fazer logout:', e);
      } finally {
        // server-side session will be destroyed by the API; redirect to login
        window.location.href = '/admin-login.html';
      }
    });

    // auto-load inscriptions on open
    (async ()=>{ try{ const data = await fetchJson('/api/admin/inscricoes'); renderInscricoes(data);}catch(e){ /* ignore */ } })();
  </script>
  <script src="admin.js" defer></script>
</body>
</html>